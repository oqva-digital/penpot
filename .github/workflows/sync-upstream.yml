name: Sync Upstream

on:
  schedule:
    - cron: '0 2 * * *'  # Every day at 2am UTC
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main  # Checkout main branch first
      
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote add upstream https://github.com/penpot/penpot.git || true
      
      - name: Fetch upstream
        run: |
          git fetch upstream
      
      - name: Check if main branch exists
        id: check_main
        run: |
          if git show-ref --verify --quiet refs/heads/main; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create main branch if needed
        if: steps.check_main.outputs.exists == 'false'
        run: |
          git checkout -b main upstream/main
      
      - name: Checkout main branch
        if: steps.check_main.outputs.exists == 'true'
        run: |
          git checkout main
      
      - name: Check if update needed
        id: check_update
        run: |
          LOCAL_COMMIT=$(git rev-parse main 2>/dev/null || echo "")
          UPSTREAM_COMMIT=$(git rev-parse upstream/main 2>/dev/null || echo "")
          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "needed=false" >> $GITHUB_OUTPUT
            echo "Already up to date with upstream"
          else
            echo "needed=true" >> $GITHUB_OUTPUT
            echo "New commits found. Local: $LOCAL_COMMIT, Upstream: $UPSTREAM_COMMIT"
          fi
      
      - name: Merge upstream/main into main
        if: steps.check_update.outputs.needed == 'true'
        run: |
          git merge upstream/main --no-ff -m "Auto-sync from upstream $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
      
      - name: Push main branch
        if: steps.check_update.outputs.needed == 'true'
        run: |
          git push origin main || exit 0
      
      - name: Checkout develop branch
        run: |
          git checkout develop || git checkout -b develop
      
      - name: Merge main into develop
        if: steps.check_update.outputs.needed == 'true'
        run: |
          git merge main --no-ff -m "Auto-merge main into develop $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git push origin develop || exit 0
      
      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_update.outputs.needed }}" == "true" ]; then
            echo "✅ Successfully synced upstream/main → main → develop" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Already up to date with upstream" >> $GITHUB_STEP_SUMMARY
          fi